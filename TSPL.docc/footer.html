<!--
This source file is part of the Swift.org open source project

Copyright (c) 2014 - 2022 Apple Inc. and the Swift project authors
Licensed under Apache License v2.0 with Runtime Library Exception

See https://swift.org/LICENSE.txt for license information
See https://swift.org/CONTRIBUTORS.txt for the list of Swift project authors
-->

<script src="https://swift.org/assets/javascripts/docc/footer.js"></script>
<footer id="footer" role="contentinfo" hidden>
  <div class="container">
    <div>
      <p class="copyright">Copyright © 2014–2023 Apple Inc. and the Swift project authors. All rights reserved.</p>
      <p>This document is made available under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/" style="color: #09f">Creative Commons Attribution 4.0 International (CC BY 4.0) License</a>.</p>
      <p class="trademark">Swift and the Swift logo are trademarks of Apple Inc.</p>
      <p class="privacy">
        <a href="//www.apple.com/privacy/privacy-policy/">Privacy Policy</a>
        <a href="//www.apple.com/legal/privacy/en-ww/cookies/">Cookies</a>
      </p>
    </div>
    <div class="footer-other">
      <form
        class="color-scheme-toggle"
        role="radiogroup"
        tabindex="0"
        id="color-scheme-toggle"
      >
        <legend class="visuallyhidden">Color scheme preference</legend>
        <label for="scheme-light">
          <input id="scheme-light" type="radio" class="visuallyhidden" name="color-scheme-preference" value="light" onchange="doccAppearance('light')">
          <span class="color-scheme-toggle-label">Light</span>
        </label>
        <label for="scheme-dark">
          <input id="scheme-dark" type="radio" class="visuallyhidden" name="color-scheme-preference" value="dark" onchange="doccAppearance('dark')">
          <span class="color-scheme-toggle-label">Dark</span>
        </label>
        <label for="scheme-auto" id="scheme-auto-wrapper">
          <input id="scheme-auto" type="radio" class="visuallyhidden" name="color-scheme-preference" value="auto" onchange="doccAppearance('auto')">
          <span class="color-scheme-toggle-label">Auto</span>
        </label>
      </form>
      <aside>
      <a href="/atom.xml" title="Subscribe to Site Updates"><i class="feed"></i></a>
      <a href="https://twitter.com/swiftlang" rel="nofollow" title="Follow @SwiftLang on Twitter"><i class="twitter"></i></a>
    </aside>
    </div>
  </div>
  <style type="text/css">
    /*
    Expanded SCSS from apple/swift-org-website commit a09c14493f812:
    /assets/stylesheets/_screen.scss#L925
    */
    .color-scheme-toggle {
        display: block;
        outline: none;
        --toggle-color-fill: var(--color-button-background);
        font-size: 12px;
        border: 1px solid #fff;
        border-radius: 4px;
        display: inline-flex;
        padding: 1px;
        margin-bottom: 1em;
    }

    .color-scheme-toggle input {
        position: absolute;
        clip: rect(1px, 1px, 1px, 1px);
        clip-path: inset(0px 0px 99.9% 99.9%);
        overflow: hidden;
        height: 1px;
        width: 1px;
        padding: 0;
        border: 0;
        appearance:none
    }

    .color-scheme-toggle-label {
        border: 1px solid transparent;
        border-radius: var(--toggle-border-radius-inner, 2px);
        display: inline-block;
        text-align: center;
        padding: 1px 6px;
        min-width: 42px;
        box-sizing:border-box
    }

    .color-scheme-toggle-label:hover {
        cursor:pointer
    }

    input:checked + .color-scheme-toggle-label {
        background: #fff;
        color: rgba(42,42,42,0.9);
    }

    [role="contentinfo"] {
        display: flex;
        justify-content:space-between
    }

    .visuallyhidden {
        position: absolute;
        clip: rect(1px, 1px, 1px, 1px);
        clip-path: inset(0px 0px 99.9% 99.9%);
        overflow: hidden;
        height: 1px;
        width: 1px;
        padding: 0;
        border:0
    }
  </style>
  <script type="text/javascript">
    // DocC uses this local storage key to persist appearance preferences.
    const appearanceKey = 'developer.setting.preferredColorScheme'
    const searchKey = 'developer.setting.pageContentQuery'
    window.addEventListener('DOMContentLoaded', _ => {
      let appearancePreference = localStorage.getItem(appearanceKey)
      if (appearancePreference) {
        // Set a color scheme according to a saved preference.
        document.body.dataset.colorScheme = appearancePreference
        document.querySelector('custom-footer')
          .shadowRoot
          .querySelector(`#scheme-${appearancePreference}`)
          .checked = true
      } else {
        document.querySelector('custom-footer')
          .shadowRoot
          .querySelector(`#scheme-auto`)
          .checked = true
      }

      setTimeout(prepareSearch, 1000)
      setTimeout(resolveSearch, 500)
    })

    // Set a color scheme based on user choice and persist it.
    function doccAppearance(mode) {
      document.body.dataset.colorScheme = mode
      switch(mode) {
      case 'light':
        localStorage.setItem(appearanceKey, mode)
        break
      case 'dark':
        localStorage.setItem(appearanceKey, mode)
        break
      case 'auto':
        localStorage.removeItem(appearanceKey)
        break
      }
    }

    function resolveSearch() {
      let query = localStorage.getItem(searchKey)
      if(query) {
        localStorage.removeItem(searchKey)
        document.location.hash = `#:~:text=${ encodeURIComponent(query) }`
      }
    }

    function prepareSearch() {
      let searchModalParent = document.querySelector('.vue-portal-target')

      let observer = new MutationObserver((list, observer) => {
        let target = document.querySelector('.vue-portal-target')

        if (target.children.length == 1) {
          let searchField = target.querySelector('input')
          searchField.addEventListener('beforeinput', e => {
            let query = searchField.value + (e.data ? e.data : '')
            console.log(`search for ${ query }`)
            let results = search(query)
            console.log(results.length, results)

            setTimeout(_ => {
              let noNormalResults = document.querySelector('.no-results')
              let someNormalResults = document.querySelector('.quick-navigation__match-list')
              if(noNormalResults) {
                noNormalResults.innerHTML = ''
                for(result of results) {
                  noNormalResults.appendChild(resultElement(result))
                }
              } else if(someNormalResults) {
                document.querySelector('.quick-navigation__match-list').style.display = 'block'
                someNormalResults.innerHTML = ''
                for(result of results) {
                  someNormalResults.appendChild(resultElement(result))
                }
              } else {
                noNormalResults.innerHTML = ''
                someNormalResults.innerHTML = ''
              }
            }, 300)

          })
        }
      })

      observer.observe(searchModalParent, { childList: true })

      downloadSearchIndex()
        .then(chapters => bookChapters = chapters)
    }

    let bookContents = [
      '/swift-book/data/documentation/the-swift-programming-language/aboutswift.json',
      '/swift-book/data/documentation/the-swift-programming-language/compatibility.json',
      '/swift-book/data/documentation/the-swift-programming-language/guidedtour.json',
      '/swift-book/data/documentation/the-swift-programming-language/thebasics.json',
      '/swift-book/data/documentation/the-swift-programming-language/basicoperators.json',
      '/swift-book/data/documentation/the-swift-programming-language/stringsandcharacters.json',
      '/swift-book/data/documentation/the-swift-programming-language/collectiontypes.json',
      '/swift-book/data/documentation/the-swift-programming-language/controlflow.json',
      '/swift-book/data/documentation/the-swift-programming-language/functions.json',
      '/swift-book/data/documentation/the-swift-programming-language/closures.json',
      '/swift-book/data/documentation/the-swift-programming-language/enumerations.json',
      '/swift-book/data/documentation/the-swift-programming-language/classesandstructures.json',
      '/swift-book/data/documentation/the-swift-programming-language/properties.json',
      '/swift-book/data/documentation/the-swift-programming-language/methods.json',
      '/swift-book/data/documentation/the-swift-programming-language/subscripts.json',
      '/swift-book/data/documentation/the-swift-programming-language/inheritance.json',
      '/swift-book/data/documentation/the-swift-programming-language/initialization.json',
      '/swift-book/data/documentation/the-swift-programming-language/deinitialization.json',
      '/swift-book/data/documentation/the-swift-programming-language/optionalchaining.json',
      '/swift-book/data/documentation/the-swift-programming-language/errorhandling.json',
      '/swift-book/data/documentation/the-swift-programming-language/concurrency.json',
      '/swift-book/data/documentation/the-swift-programming-language/macros.json',
      '/swift-book/data/documentation/the-swift-programming-language/typecasting.json',
      '/swift-book/data/documentation/the-swift-programming-language/nestedtypes.json',
      '/swift-book/data/documentation/the-swift-programming-language/extensions.json',
      '/swift-book/data/documentation/the-swift-programming-language/protocols.json',
      '/swift-book/data/documentation/the-swift-programming-language/generics.json',
      '/swift-book/data/documentation/the-swift-programming-language/opaquetypes.json',
      '/swift-book/data/documentation/the-swift-programming-language/automaticreferencecounting.json',
      '/swift-book/data/documentation/the-swift-programming-language/memorysafety.json',
      '/swift-book/data/documentation/the-swift-programming-language/accesscontrol.json',
      '/swift-book/data/documentation/the-swift-programming-language/advancedoperators.json',
      '/swift-book/data/documentation/the-swift-programming-language/aboutthelanguagereference.json',
      '/swift-book/data/documentation/the-swift-programming-language/lexicalstructure.json',
      '/swift-book/data/documentation/the-swift-programming-language/types.json',
      '/swift-book/data/documentation/the-swift-programming-language/expressions.json',
      '/swift-book/data/documentation/the-swift-programming-language/statements.json',
      '/swift-book/data/documentation/the-swift-programming-language/declarations.json',
      '/swift-book/data/documentation/the-swift-programming-language/attributes.json',
      '/swift-book/data/documentation/the-swift-programming-language/patterns.json',
      '/swift-book/data/documentation/the-swift-programming-language/genericparametersandarguments.json',
      '/swift-book/data/documentation/the-swift-programming-language/summaryofthegrammar.json'
    ]

    let bookChapters = []

    // FIXME: This shouldn't be a global.
    let lastResultPage = ''

    async function downloadSearchIndex() {
      let chapters = []
      for(let url of bookContents) {
        let chapterResponse = await fetch(url)
        let chapter = await chapterResponse.json()
        console.log('Chapter debug', chapter)
        chapters.push(chapter)
      }

      return chapters
    }

    function search(query) {
      let results = []
      for (chapter of bookChapters) {
        lastResultPage = (new URL(chapter.identifier.url)).pathname.split('/').at(-1)
        let result = leafNodeSearch(query, chapter.primaryContentSections[0].content)
        results.push(...result)
      }

      return results
    }

    function leafNodeSearch(query, contents) {
      let results = []
      for(content of contents) {
        if(content.code) {
          let result = searchCode(query, content.code)
          results.push(...result)
        } else if (content.inlineContent) {
          let result = searchInlineContent(query, content.inlineContent)
          results.push(...result)
        } else if (content.anchor) {
          let result = searchAnchor(query, content)
          results.push(...result)
        } else if (content.items) {
          let result = searchItems(query, content.items)
          results.push(...result)
        }
      }
      return results
    }

    function searchCode(query, codeArray) {
      let results = []
      for(line of codeArray) {
        if(line.includes(query)) {
          results.push({ match: line, type: 'code', page: lastResultPage })
        }
      }

      return results
    }

    function searchInlineContent(query, contentArray) {
      let results = []
      for(element of contentArray) {
        if(element.text && element.text.includes(query)) {
          results.push({ match: element.text, type: 'text', page: lastResultPage })
        } else if(element.code && element.code.includes(query)) {
          results.push({ match: element.code, type: 'code', page: lastResultPage })
        }
      }

      return results
    }

    function searchItems(query, items) {
      let results = []
      for(item of items) {
        if(item.content && item.content[0] && item.content[0].inlineContent) {
          results.push(...searchInlineContent(query, item.content[0].inlineContent))
        }
      }

      return results
    }

    function searchAnchor(query, anchor) {
      if(anchor.text.toLowerCase().includes(query.toLowerCase())) {
        return [{ match: anchor.text, type: 'anchor', page: lastResultPage }]
      }
      return []
    }

    let nodeMap = {
      'text': 'SPAN',
      'code': 'PRE',
      'anchor': 'STRONG'
    }

    function resultElement(result) {
      let wrapper = document.createElement('DIV')
      let node = document.createElement(nodeMap[result.type])
      node.innerText = result.match
      wrapper.appendChild(node)
      wrapper.style.border = 'dotted'
      wrapper.style.cursor = 'pointer'
      wrapper.addEventListener('click', _ => {
        localStorage.setItem(searchKey, result.match)
        document.location.href = `/swift-book/documentation/the-swift-programming-language/${result.page.toLowerCase()}`
      })
      return wrapper
    }
  </script>
</footer>
